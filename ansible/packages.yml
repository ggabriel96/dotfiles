---
- name: Install general packages
  hosts: Fedora
  become: true
  tags:
    - packages
  tasks:
    - name: DNF update all
      ansible.builtin.dnf:
        name: "*"
        state: latest

    - name: Install general packages
      ansible.builtin.dnf:
        name:
          - chromium
          - clang
          - dnf-plugins-core
          - fedora-workstation-repositories
          - fish
          - gcc-c++
          - gnome-tweaks
          - htop
          - make
          - neovim
          - zsh
        state: latest

    - name: Clean up
      ansible.builtin.dnf:
        autoremove: yes

- name: Install Miniconda
  hosts: localhost
  vars_files:
    - vars/packages.yml
  tags:
    - dev
    - package-managers
    - packages
    - python
  tasks:
    - name: Check if already installed
      ansible.builtin.stat:
        path: "{{ miniconda_install_dir }}/miniconda3/"
      register: is_miniconda_installed

    - name: End play if already installed
      meta: end_play
      when: is_miniconda_installed.stat.exists

    - name: Download
      ansible.builtin.get_url:
        url: https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
        dest: /tmp/miniconda-install.sh
        mode: "0755"

    - name: Install
      ansible.builtin.command:
        argv:
          - /tmp/miniconda-install.sh
          - -b

    - name: Clean up
      ansible.builtin.file:
        path: /tmp/miniconda-install.sh
        state: absent

- name: Install Fonts
  hosts: Fedora
  become: true
  tags:
    - fonts
    - packages
  tasks:
    - ansible.builtin.dnf:
        name:
          - fira-code-fonts
          - fontawesome-fonts
          - google-noto-sans-fonts
          - google-noto-serif-fonts
          - google-noto-emoji-fonts
          - google-noto-emoji-color-fonts
        state: latest

- name: Install Google Cloud SDK
  hosts: localhost
  vars_files:
    - vars/packages.yml
  tags:
    - dev
    - gcp
    - packages
  tasks:
    - name: Check if already installed
      ansible.builtin.stat:
        path: "{{ cloudsdk_install_dir }}/google-cloud-sdk/"
      register: is_cloudsdk_installed

    - name: End play if already installed
      meta: end_play
      when: is_cloudsdk_installed.stat.exists

    - name: Download
      ansible.builtin.get_url:
        url: https://sdk.cloud.google.com
        dest: /tmp/cloudsdk-install.sh
        mode: "0755"

    - name: Install
      ansible.builtin.command:
        argv:
          - /tmp/cloudsdk-install.sh
          - --disable-prompts
          - --install-dir={{ cloudsdk_install_dir }}

    - name: Clean up
      ansible.builtin.file:
        path: /tmp/cloudsdk-install.sh
        state: absent

- name: Setup Flatpak and install packages
  hosts: Fedora
  tags:
    - flatpak
    - package-managers
    - packages
  tasks:
    - name: Add Flathub repository
      ansible.builtin.command:
        argv:
          - flatpak
          - remote-add
          - --if-not-exists
          - flathub
          - https://flathub.org/repo/flathub.flatpakrepo
    - name: Install packages
      ansible.builtin.command:
        argv:
          - flatpak
          - install
          - flathub
          - -y
          - com.dropbox.Client
          - com.github.calo001.fondo

- name: Setup Snap and install packages
  hosts: localhost
  become: true
  tags:
    - package-managers
    - packages
    - snap
  tasks:
    - ansible.builtin.dnf:
        name:
          - snapd
      when: ansible_facts["distribution"] == "Fedora"

    - name: Symlink
      ansible.builtin.file:
        src: /var/lib/snapd/snap
        dest: /snap
        state: link
      when: ansible_facts["distribution"] == "Fedora"

    - name: Install packages
      community.general.snap:
        classic: no
        state: present
        channel: stable
        name:
          - spotify
          - vlc

    - name: Install packages requiring classic confinement
      community.general.snap:
        classic: yes
        state: present
        channel: stable
        name:
          - code
          - slack

- name: Install SpaceVim
  hosts: localhost
  vars_files:
    - vars/packages.yml
  tags:
    - dev
    - editors
    - packages
  tasks:
    - name: Download
      ansible.builtin.get_url:
        url: https://spacevim.org/install.sh
        dest: /tmp/spacevim-install.sh
        mode: "0755"

    - name: Install
      ansible.builtin.command:
        argv:
          - /tmp/spacevim-install.sh

    - name: Clean up
      ansible.builtin.file:
        path: /tmp/spacevim-install.sh
        state: absent

- name: Install Zoom
  hosts: Fedora
  become: true
  tags:
    - meeting
    - packages
    - video
  tasks:
    - name: Add GPG key
      ansible.builtin.rpm_key:
        key: https://zoom.us/linux/download/pubkey
        state: present

    - name: Download package
      ansible.builtin.get_url:
        url: https://zoom.us/client/latest/zoom_x86_64.rpm
        dest: /tmp/zoom.rpm

    - name: Install
      ansible.builtin.dnf:
        name:
          - /tmp/zoom.rpm
        state: latest

    - name: Clean up
      ansible.builtin.file:
        path: /tmp/zoom.rpm
        state: absent
